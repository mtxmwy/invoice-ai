# Invoice Agent (LangChain4j)

一个基于 **LangChain4j + 多模态大模型** 的发票识别与风控示例项目，用于演示如何在真实业务场景中构建 **可控、可反思、可人工兜底的 AI Agent**，解决财务发票人工录入效率低、错误率高的问题。

> 本项目重点不在“调模型”，而在 **Agent 工程设计**：结构化抽取、评判、反思、修正、人工兜底。

---

## 背景

在实际企业中，财务人员需要手动录入大量发票信息（开票日期、金额、税额、购买方等），该过程：

* 耗时高
* 易出错
* 人力成本高

本项目通过引入 **多模态 LLM + Agent 机制**，实现从发票图片到结构化数据的自动提取，并在关键环节加入 **风险评估与人工复核机制**，避免模型错误直接污染业务数据。

---

## 核心特性

### 多模态发票识别

* 直接传入 **发票图片 URL**
* 使用多模态大模型识别发票内容
* 避免传统 OCR + 规则链路的复杂度（同时保留可替换设计）

### 结构化字段抽取（Function Calling）

* 严格 schema 定义（日期、金额、税额、主体信息等）
* 不允许模型自由发挥
* 不确定字段返回 `null`

### 评判 Agent（Critic Agent）

对抽取结果进行二次校验，例如：

* 时间逻辑（是否为未来日期）
* 关键字段缺失
* 金额 / 税额合理性

> 所有时间判断均由 **系统注入当前日期**，避免模型时间认知漂移。

### 反思 → 修正（Reflexion Loop）

* 将评判 Agent 给出的 **结构化反馈**
* 作为 **动态 Prompt** 回传给抽取 Agent
* 进行 **有限次数（默认 1 次）定向修正**

避免：

* 无限自我循环
* 错误自我强化

### 人工兜底机制（Human-in-the-loop）

当出现以下情况时，自动进入人工复核：

* 多次修正仍失败
* 抽取与评判 Agent 同时不确定
* 高风险业务规则触发

---

## 整体流程

```text
发票文件 URL
      ↓
多模态发票抽取 Agent
      ↓
结构化发票数据
      ↓
评判 Agent（规则 + 时间事实）
      ↓
需要修正？ —— 否 → 入库
      ↓ 是
反馈（reason）
      ↓
再次抽取（带反馈）
      ↓
仍失败 → 人工复核
```

---

## 技术栈

* Java 17+
* LangChain4j
* 多模态大语言模型（支持图片 URL）
* Function Calling / Tool Calling

> 本项目 **不依赖 Python**，适合 Java 技术栈团队参考。

---

## 示例：动态反馈修正 Prompt

```text
【复核反馈】
1. 上一次识别的发票日期为 2026-02-01
2. 当前系统日期为 2026-02-03，时间逻辑无异常
3. 不需要修正发票日期字段

请基于以上反馈重新输出完整发票结构化信息。
```

---

## 设计原则（重要）

* 不把 LLM 当黑盒

* 不允许模型自行假设“当前时间”

* 不无限重试

* 外部事实由系统注入

* 风险可解释、可追溯

* 人工始终是最后一道防线

---

## 适用场景

* 发票 / 单据 / 凭证识别
* 财务自动化
* 企业内部 Agent 工程示例
* 面试 / 学习 LangChain4j Agent 架构

---

## 非目标

* 本项目 **不是** 通用 OCR 替代品
* 本项目 **不追求** 100% 自动化
* 本项目 **不建议** 无人工兜底直接上线生产

---

## Roadmap（可选）

* [ ] 多模态混合策略
* [ ] 金额 / 税率规则引擎
* [ ] Agent 状态机可视化
* [ ] 审计日志与可观测性

---

## License

MIT License

---

## 说明

这是一个 **偏工程实践的 Agent 示例项目**，欢迎交流、讨论、PR。

如果你正在：

* 学习 LangChain4j
* 准备 AI Agent 相关面试
* 探索 LLM 在真实业务中的落地方式

希望这个项目能对你有所帮助。
